name: Create Unity Release PR

on:
  workflow_dispatch:
    inputs:
      bump_command:
        description: "Version bump type (major, minor, patch, specify)"
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
          - specify
      postfix:
        description: "Optional postfix (e.g. preview, beta, or specific version when using 'specify')"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  compose-unity-release:
    name: Compose Unity Release
    runs-on: macos-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BUMP_COMMAND: ${{ github.event.inputs.bump_command }}
      POSTFIX: ${{ github.event.inputs.postfix }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          
      - name: Prepare Environment
        run: |
          brew install gh jq || true
          gh auth status || gh auth login --with-token <<< "$GH_TOKEN"

      - name: Cache Unity
        uses: actions/cache@v4
        with:
          path: /Applications/Unity/Hub
          key: UnityEditor-${{ runner.os }}
          restore-keys: |
            UnityEditor-${{ runner.os }}

      - name: Setup Unity
        uses: buildalon/unity-setup@v2.1.1
        with:
          version-file: 'OneSignalExample/ProjectSettings/ProjectVersion.txt'

      - uses: buildalon/activate-unity-license@v2
        with:
          license: 'Personal'
          username: '${{ secrets.UNITY_USERNAME }}'
          password: '${{ secrets.UNITY_PASSWORD }}'

      - name: ðŸ—ï¸ Run composeRelease.sh
        run: |
          chmod +x ./composeRelease.sh
          if [[ -n "$POSTFIX" ]]; then
            ./composeRelease.sh "$BUMP_COMMAND" "$POSTFIX" || echo "composeRelease.sh failed, continuing to patch manually"
          else
            ./composeRelease.sh "$BUMP_COMMAND" || echo "composeRelease.sh failed, continuing to patch manually"
          fi

      - name: ðŸ” Confirm PR Exists
        run: |
          PR_URL=$(gh pr list --head "release/$VERSION" --json url --jq '.[0].url')
          if [[ -n "$PR_URL" ]]; then
            echo "âœ… Release PR found: $PR_URL"
          else
            echo "âš ï¸ No PR found. composeRelease.sh should have created one."
            echo "If missing, create manually from release/$VERSION â†’ main."
          fi

name: Create Unity Release PR

on:
  workflow_dispatch:
    inputs:
      bump_command:
        description: "Version bump type (major, minor, patch, specify)"
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
          - specify
      postfix:
        description: "Optional postfix (e.g. preview, beta, or specific version when using 'specify')"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  compose-unity-release:
    name: Compose Unity Release
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BUMP_COMMAND: ${{ github.event.inputs.bump_command }}
      POSTFIX: ${{ github.event.inputs.postfix }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          
      - name: Prepare Environment
        run: |
          brew install gh jq || true
          gh auth status || gh auth login --with-token <<< "$GH_TOKEN"
          
      - name: Set up Unity
        uses: buildalon/unity-setup@v2.1.1
        with:
          unity-version: '2021.3.0f1'  # the oldest version of Unity we want to support and upload from
          modules: 'linux-il2cpp android ios'
          github-token: ${{ secrets.GITHUB_TOKEN }}


      - name: ðŸ” Confirm PR Exists
        run: |
          PR_URL=$(gh pr list --head "release/$VERSION" --json url --jq '.[0].url')
          if [[ -n "$PR_URL" ]]; then
            echo "âœ… Release PR found: $PR_URL"
          else
            echo "âš ï¸ No PR found. composeRelease.sh should have created one."
            echo "If missing, create manually from release/$VERSION â†’ main."
          fi
